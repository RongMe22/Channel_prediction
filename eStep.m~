function X = eStep(parameter, csi)

global M L LAMBDA D FREQUENCY

% csi = csi';
% csi is a vector;
% theta = [alpha, azimuthal_angle, tau];
% C = zeros(M,L);

% S: MxL matrix;
% S = zeros(M,L);


C_M = repmat(transpose(0:M-1), 1, L);
C_L = repmat(cos(parameter.phi), M, 1);
C = exp(-1j*2*pi/LAMBDA*D*C_M.*C_L);
S = repmat(parameter.alpha, M, 1) .* C .* ...
    exp(-1j*2*pi*FREQUENCY*repmat(parameter.tau, M, 1));

X = repmat(csi - sum(S, 2), 1,L) + S;


for a = 1:M
    
    C = zeros(1,L);
    G = zeros(1,L);
    alpha = zeros(1,L);
    % X = alpha*C*G;
    
    for b = 1:L
        
        alpha(b) = theta(b,1);
        
        a_angle = theta(b,2);
        C(b) = exp((1i)*(2*pi/lambda)*(a-1)*d*cos(a_angle));
        
        tau = theta(b,3);
        G(b) = exp(-(1i)*2*pi*tau*freq);
    end
    
    alpha = repmat(alpha,L,1);
    C = repmat(C,L,1);
    G = repmat(G,L,1);
    G = G.';
    C = C-C.*eye(size(C));
    alpha = alpha - alpha.*eye(size(alpha));
    % has the following code or do not have has the same effect;
    %G = G - G.*eye(size(G));
    S_temp = alpha.*C*G;
    S(a,:) = diag(S_temp).';
end

H = repmat(csi,L,1);
H = H.';
X = H - S;

end
